// Service de reconnaissance vocale pour Maya Voice Translator
import { Audio } from 'expo-av';
import * as Speech from 'expo-speech';
import { LANGUAGE_MAPPING } from './TranslationService.js';

class VoiceService {
  constructor() {
    this.recording = null;
    this.isRecording = false;
  }

  /**
   * Initialise les permissions audio
   */
  async initializeAudio() {
    try {
      const permission = await Audio.requestPermissionsAsync();
      if (!permission.granted) {
        throw new Error('Permission d\'enregistrement audio requise');
      }

      await Audio.setAudioModeAsync({
        allowsRecordingIOS: true,
        playsInSilentModeIOS: true,
      });

      return true;
    } catch (error) {
      console.error('Erreur initialisation audio:', error);
      throw error;
    }
  }

  /**
   * DÃ©marre l'enregistrement vocal
   */
  async startRecording() {
    try {
      if (this.isRecording) {
        throw new Error('Enregistrement dÃ©jÃ  en cours');
      }

      await this.initializeAudio();

      this.recording = new Audio.Recording();
      await this.recording.prepareToRecordAsync({
        android: {
          extension: '.m4a',
          outputFormat: Audio.RECORDING_OPTION_ANDROID_OUTPUT_FORMAT_MPEG_4,
          audioEncoder: Audio.RECORDING_OPTION_ANDROID_AUDIO_ENCODER_AAC,
          sampleRate: 44100,
          numberOfChannels: 2,
          bitRate: 128000,
        },
        ios: {
          extension: '.m4a',
          outputFormat: Audio.RECORDING_OPTION_IOS_OUTPUT_FORMAT_MPEG4AAC,
          audioQuality: Audio.RECORDING_OPTION_IOS_AUDIO_QUALITY_HIGH,
          sampleRate: 44100,
          numberOfChannels: 2,
          bitRate: 128000,
          linearPCMBitDepth: 16,
          linearPCMIsBigEndian: false,
          linearPCMIsFloat: false,
        },
        web: {
          mimeType: 'audio/webm',
          bitsPerSecond: 128000,
        },
      });

      await this.recording.startAsync();
      this.isRecording = true;
      
      return true;
    } catch (error) {
      console.error('Erreur dÃ©marrage enregistrement:', error);
      throw error;
    }
  }

  /**
   * ArrÃªte l'enregistrement et retourne l'URI du fichier
   */
  async stopRecording() {
    try {
      if (!this.isRecording || !this.recording) {
        throw new Error('Aucun enregistrement en cours');
      }

      await this.recording.stopAndUnloadAsync();
      const uri = this.recording.getURI();
      
      this.recording = null;
      this.isRecording = false;

      return uri;
    } catch (error) {
      console.error('Erreur arrÃªt enregistrement:', error);
      throw error;
    }
  }  /**
   * Lit un texte avec la synthÃ¨se vocale
   */
  async speakText(text, language = 'fr') {
    try {
      // Pour les langues Maya, nous devons adapter la prononciation
      let adaptedText = text;
      let speechLanguage = LANGUAGE_MAPPING.speech[language] || 'fr-FR';
      
      // Adaptation phonÃ©tique pour les langues Maya
      if (['yua', 'quc', 'cak'].includes(language)) {
        adaptedText = this.adaptMayaPronunciation(text, language);
        // Utiliser l'espagnol comme base pour une meilleure prononciation
        speechLanguage = language === 'yua' ? 'es-MX' : 'es-GT';
      }
      
      const speechOptions = {
        language: speechLanguage,
        pitch: 1.0,
        rate: 0.7, // Plus lent pour les langues Maya
        quality: Speech.VoiceQuality.Enhanced,
      };

      console.log(`ðŸ”Š Lecture vocale: "${text}" â†’ "${adaptedText}" en ${speechLanguage}`);
      await Speech.speak(adaptedText, speechOptions);
      return true;
    } catch (error) {
      console.error('Erreur synthÃ¨se vocale:', error);
      
      // Fallback avec la langue par dÃ©faut
      try {
        await Speech.speak(text, {
          language: 'fr-FR',
          pitch: 1.0,
          rate: 0.8
        });
        return true;
      } catch (fallbackError) {
        throw error;
      }
    }
  }
  /**
   * Adapte la prononciation Maya pour la synthÃ¨se vocale espagnole
   */
  adaptMayaPronunciation(text, language) {
    let adaptedText = text;
    
    // Phase 1: Nettoyage des caractÃ¨res spÃ©ciaux
    adaptedText = adaptedText
      // Supprimer les apostrophes glottales (problÃ©matiques pour TTS)
      .replace(/'/g, '')
      // Supprimer les avertissements et symboles
      .replace(/âš ï¸.*?\)/g, '')
      .replace(/âŒ.*$/g, '')
      .replace(/ðŸ’¡.*$/g, '');
    
    // Phase 2: Adaptations phonÃ©tiques gÃ©nÃ©rales Maya
    adaptedText = adaptedText
      // Consonnes complexes maya
      .replace(/tz/g, 'ts') // tz maya â†’ ts (plus proche phonÃ©tiquement)
      .replace(/ch'/g, 'ch') // ch' Ã©jectif â†’ ch simple
      .replace(/k'/g, 'qu') // k' Ã©jectif â†’ qu (espagnol)
      .replace(/p'/g, 'p') // p' Ã©jectif â†’ p simple
      .replace(/t'/g, 't') // t' Ã©jectif â†’ t simple
      .replace(/q'/g, 'k') // q' â†’ k
      
      // Fricatives et affriquÃ©es
      .replace(/x/g, 'j') // x maya â†’ j espagnol (como joven)
      .replace(/xh/g, 'sh') // xh â†’ sh
      .replace(/rr/g, 'r') // double r â†’ simple r
      
      // Voyelles spÃ©ciales
      .replace(/Ã¤/g, 'a') // a central â†’ a normal
      .replace(/Ã«/g, 'e') // e central â†’ e normal
      .replace(/Ã¯/g, 'i') // i central â†’ i normal
      .replace(/Ã¶/g, 'o') // o central â†’ o normal
      .replace(/Ã¼/g, 'u') // u central â†’ u normal
      
      // Voyelles longues (rÃ©duites pour TTS)
      .replace(/aa/g, 'a')
      .replace(/ee/g, 'e') 
      .replace(/ii/g, 'i')
      .replace(/oo/g, 'o')
      .replace(/uu/g, 'u')
      
      // Consonnes gÃ©minÃ©es
      .replace(/ll/g, 'l')
      .replace(/nn/g, 'n')
      .replace(/mm/g, 'm');
    
    // Phase 3: Adaptations spÃ©cifiques par langue
    switch (language) {
      case 'yua': // Maya Yucateco
        adaptedText = adaptedText
          // PhonÃ¨mes spÃ©cifiques yucatecos
          .replace(/dz/g, 'ds')
          .replace(/w/g, 'u') // w â†’ u (approximation)
          .replace(/y/g, 'i') // y final â†’ i
          // Groupes consonantiques complexes
          .replace(/chb/g, 'chab')
          .replace(/kb/g, 'kab')
          .replace(/pb/g, 'pab');
        break;
        
      case 'quc': // K'iche'
        adaptedText = adaptedText
          // Consonnes rÃ©troflexes et Ã©jectives spÃ©cifiques
          .replace(/q/g, 'k') // q â†’ k
          .replace(/7/g, '') // coup de glotte â†’ supprimÃ©
          .replace(/b'/g, 'b') // b' Ã©jectif â†’ b
          // Voyelles centrales k'iche'
          .replace(/eÌ±/g, 'e')
          .replace(/oÌ±/g, 'o');
        break;
        
      case 'cak': // Kaqchikel  
        adaptedText = adaptedText
          // CaractÃ©ristiques kaqchikel
          .replace(/q/g, 'k')
          .replace(/7/g, '') // coup de glotte
          .replace(/j/g, 'h') // j â†’ h aspirÃ©
          // Diphtongues
          .replace(/aj/g, 'ai')
          .replace(/ej/g, 'ei')
          .replace(/oj/g, 'oi');
        break;
    }
    
    // Phase 4: Post-traitement pour TTS espagnol
    adaptedText = adaptedText
      // Assurer compatibilitÃ© avec TTS espagnol
      .replace(/^h/g, '') // h initial muet
      .replace(/h$/g, '') // h final muet
      .replace(/w/g, 'gu') // w restant â†’ gu
      // Simplifier les groupes consonantiques complexes
      .replace(/([bcdfghjklmnpqrstvwxyz])\1+/g, '$1') // consonnes doublÃ©es
      // Ajouter voyelles d'appui si nÃ©cessaire
      .replace(/([bcdfghjklmnpqrstvwxyz])([bcdfghjklmnpqrstvwxyz])([bcdfghjklmnpqrstvwxyz])/g, '$1e$2$3')
      // Nettoyage final
      .replace(/\s+/g, ' ')
      .trim();
    
    // Phase 5: VÃ©rification et correction finale
    if (adaptedText.length === 0) {
      adaptedText = text.replace(/[^\w\s]/g, ''); // Fallback: garder seulement lettres et espaces
    }
    
    console.log(`ðŸ”„ Adaptation phonÃ©tique ${language}: "${text}" â†’ "${adaptedText}"`);
    return adaptedText;
  }

  /**
   * ArrÃªte la lecture vocale en cours
   */
  async stopSpeaking() {
    try {
      await Speech.stop();
      return true;
    } catch (error) {
      console.error('Erreur arrÃªt synthÃ¨se vocale:', error);
      throw error;
    }
  }

  /**
   * VÃ©rifie si un enregistrement est en cours
   */
  getRecordingStatus() {
    return {
      isRecording: this.isRecording,
      hasRecording: this.recording !== null
    };
  }

  /**
   * Obtient les voix disponibles pour la synthÃ¨se vocale
   */
  async getAvailableVoices() {
    try {
      // Cette fonctionnalitÃ© peut Ãªtre limitÃ©e selon la plateforme
      const voices = await Speech.getAvailableVoicesAsync();
      return voices;
    } catch (error) {
      console.warn('Impossible d\'obtenir la liste des voix:', error);
      return [];
    }
  }
  /**
   * Reconnaissance vocale via Web Speech API (navigateur)
   */
  async startSpeechRecognition(language = 'fr') {
    return new Promise((resolve, reject) => {
      // VÃ©rifier la disponibilitÃ© de l'API
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        reject(new Error('Reconnaissance vocale non supportÃ©e dans ce navigateur'));
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      
      // Configuration de la reconnaissance
      const speechLanguage = LANGUAGE_MAPPING.speech[language] || 'fr-FR';
      recognition.lang = speechLanguage;
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      console.log(`ðŸŽ¤ DÃ©marrage reconnaissance vocale en ${speechLanguage}`);

      recognition.onstart = () => {
        console.log('ðŸŽ¤ Reconnaissance vocale dÃ©marrÃ©e');
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const confidence = event.results[0][0].confidence;
        
        console.log(`âœ… Texte reconnu: "${transcript}" (confiance: ${confidence})`);
        
        resolve({
          transcript: transcript,
          confidence: confidence,
          language: language
        });
      };

      recognition.onerror = (event) => {
        console.error('âŒ Erreur reconnaissance vocale:', event.error);
        let errorMessage = 'Erreur de reconnaissance vocale';
        
        switch(event.error) {
          case 'no-speech':
            errorMessage = 'Aucune parole dÃ©tectÃ©e';
            break;
          case 'audio-capture':
            errorMessage = 'Microphone inaccessible';
            break;
          case 'not-allowed':
            errorMessage = 'Permission microphone refusÃ©e';
            break;
          case 'network':
            errorMessage = 'Erreur rÃ©seau';
            break;
          default:
            errorMessage = `Erreur: ${event.error}`;
        }
        
        reject(new Error(errorMessage));
      };

      recognition.onend = () => {
        console.log('ðŸŽ¤ Reconnaissance vocale terminÃ©e');
      };

      // DÃ©marrer la reconnaissance
      try {
        recognition.start();
      } catch (error) {
        reject(new Error('Impossible de dÃ©marrer la reconnaissance vocale'));
      }
    });
  }
}

export default new VoiceService();
